variables:
  BUNDLE_GITLAB__COM: "gitlab-ci-token:${CI_JOB_TOKEN}"

stages:
  - test

code_quality:
  stage: test
  tags:
    - itsmycargo
  image: eu.gcr.io/itsmycargo-main/pronto:stable
  script:
    - scripts/pronto

api:
  stage: test
  tags:
    - itsmycargo
  image: eu.gcr.io/itsmycargo-main/base:stable
  services:
    - mdillon/postgis
  variables:
    POSTGRES_DB: imcr_test
    DATABASE_URL: postgis://postgres:@localhost/imcr_test
  script:
    - scripts/test

  coverage: '/\(\d+.\d+\%\) covered/'
  artifacts:
    paths:
      - coverage/
    expire_in: 1 week
    reports:
      junit:
        - engines/*/rspec.xml
        - lib/*/rspec.xml
        - rspec.xml

client:
  stage: test
  # tags:
  #   - itsmycargo
  image: node:8

  script:
    - cd client
    - npm install
    - npm run test:ci

  coverage: '/^Statements\s*:\s*([^%]+)/'
  artifacts:
    paths:
      - client/coverage/lcov-report
    expire_in: 1 week
    reports:
      junit:
        - client/junit.xml
