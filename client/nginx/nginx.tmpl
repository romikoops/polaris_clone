user nginx;
worker_processes 1;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  real_ip_header    X-Forwarded-For;
  real_ip_recursive on;

  add_header X-Host $hostname;

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

  access_log /var/log/nginx/access.log main;

  sendfile on;

  keepalive_timeout 65;

  server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;

    if ($http_x_forwarded_proto = "http") {
      return 301 https://$host$request_uri;
    }

    location = /version.json {
      try_files $uri =404;
      expires 1m;
    }

    location = /config.202003052356.js {
      add_header Content-Type application/javascript;
      add_header X-Host $hostname;
      expires 1m;

      return 200 'window.keel = {
apiUrl: \'{{ .Env.API_URL }}\',
appName: \'{{ .Env.APP_NAME }}\',
environment: \'{{ .Env.APP_ENVIRONMENT }}\',
oauthClientId: \'{{ .Env.OAUTH_CLIENT_ID }}\',
oauthClientSecret: \'{{ .Env.OAUTH_CLIENT_SECRET }}\'
}
';
    }

    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)(\.gz)?$ {
      try_files $uri =404;
      expires max;
    }

    location ~ \.map(\.gz)?$ {
      if ($http_x_sentry_token !~* "c60c8618c27c11e99e284e16e2be11ee") {
        return 403;
      }

      expires max;
    }

    location / {
      try_files $uri $uri/ /index.html;
      expires 5m;
    }
  }
}
