# frozen_string_literal: true

# Support multiple JIRA projects
JIRA_REGEXP = Regexp.new(/((?:IMC)-[0-9]+)/i)

# Search Commits
jira_issues = git.commits.map { |commit| commit.message.scan(JIRA_REGEXP) }.flatten.compact.map(&:upcase).uniq

# MR Tickets
pr_title_issues = github.pr_title.scan(JIRA_REGEXP).flatten.map(&:upcase).uniq
fix_chore_pr = /\A(chore|(hot)?fix):/i.match?(github.pr_title)

if pr_title_issues.empty? && !fix_chore_pr
  title = ':ticket: Missing JIRA Ticket'
  message = <<~MESSAGE
    Please add JIRA Ticket numer to pull request title as this makes it easy to track open
    merge requests and keep JIRA Board in sync, as well to make sure we always deploy most
    important code to production at right time.
  MESSAGE

  failure("#{title} - #{message}")
end

if !pr_title_issues.empty? && !(pr_title_issues - jira_issues).empty?
  title = ':ticket: Inconsistent JIRA Ticket'
  message = <<~MESSAGE
    This pull request mentions different JIRA tickets in commit messages and title.
    Please make sure that correct ticket numbers are mentioned in commits and title.
  MESSAGE

  failure("#{title} - #{message}")
end

if pr_title_issues.any? { |t| t.start_with?('imc') }
  title = ':ticket: Lowercase ticket number'
  message = <<~MESSAGE
    Please write all JIRA ticket numbers as upper case.
  MESSAGE

  failure("#{title} - #{message}")
end
