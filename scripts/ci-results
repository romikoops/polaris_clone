#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/inline'
require 'fileutils'
require 'pathname'

gemfile do
  source 'https://rubygems.org'
  gem 'highline'
  gem 'simplecov'
  gem 'pry'
end

CLI = HighLine.new

SimpleCov.configure { merge_timeout 3600 }
coverage = SimpleCov::ResultMerger.results.map { |r| [r.command_name, r.covered_percent] }.to_h
results = File.read(File.expand_path('../.results', __dir__)).split.map { |line| name, result = line.split(':'); [name, result.to_i] }

results.map! { |name, result| [ name, result, coverage[name] ] }.sort_by! { |r| [-r[1], r[2]] }

table = ['Component', 'Result', 'Code Coverage'].map { |h| CLI.color(h, :bold) }
results.each do |name, result, coverage|
  table << CLI.color(name, [:grey, :red][result])
  table << CLI.color(%w{SUCCESS FAILED}[result], [:green, :red][result])
  table << CLI.color(format('%<coverage>5.1f %%', coverage: coverage), coverage < 98 ? [:red, :bold] : :grey)
end

puts CLI.list(table, :columns_across, 3)

exit(results.empty? ? 0 : results.map { |r| r[1] }.reduce(:|))
