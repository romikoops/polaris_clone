  <div class="wrapper-quotations">
  <% primary_color = tenant.theme["colors"]["primary"] %>
  <% neutral_color = '#C4C4C4' %>
  <% tenant_logo_asset = "logoLarge_" + tenant["subdomain"] + ".png" %>
  <% tenant_logo_url = tenant.theme["logoLarge"] %>
  <% scope = tenant.scope %>
  <% precarriage_color = shipment.has_pre_carriage ? primary_color : neutral_color %>
  <% oncarriage_color = shipment.has_on_carriage ? primary_color : neutral_color %>

  <div class="title display-flex">
    <div>
      <h1>QUOTATIONS</h1>
      <hr style="border-color: <%= primary_color %>">
      <p><%= tenant.name %></p>
    </div>
    <div>
      <img src="<%=tenant.theme['logoSmall']%>" alt="" class="header-logo">
    </div>
    <div class="agent-info">
        <p><strong><%= shipment.user.first_name %> <%= shipment.user.last_name %></strong></p>
        <p><%= shipment.user.email %></p>
        <p><%= shipment.user.phone %></p>
        <% if shipment.user.external_id %>
          <p>Customer ID: <%= shipment.user.external_id.to_i %></p>
        <% end %>
    </div>
  </div>


  <% shipments.map do |s| %>
    <% origin_fee_color = s.selected_offer["export"] ? primary_color : neutral_color %>
    <% destination_fee_color = s.selected_offer["import"] ? primary_color : neutral_color %>
    <div class="all-row">
      <div class="main-container">
        <div class="validity">
          <p><b>Price valid until:</b></p>
          <p class="text-right"><%= s.valid_until&.strftime('%d.%m.%Y') %></p>
        </div>
        <div class="info">
          <% if s.mode_of_transport == "ocean" %>
            <% mot = "anchor" %>
          <% elsif s.mode_of_transport == "air" %>
            <% mot = "plane" %>
          <% else %>
            <% mot = "truck" %>
          <% end %>
          <i class="fa fa-<%= mot %> mot-icon" style="color: <%= primary_color %>"></i>
          <div class="shipment-info">
            <p>From:&nbsp;<span><%= s.origin_hub.name %></span></p>
            <p>To:&nbsp;<span><%= s.destination_hub.name %></span></p>
            <p>Ref:&nbsp;<span><%= s.imc_reference %></span></p>
          </div>
          <div class="text-right cargo-info">
            <div class="charge-icons">
              <i class="fa fa-truck" style="color: <%= precarriage_color %>"></i>
              <i class="fa fa-file" style="color: <%= origin_fee_color %>"></i>
              <i class="fa fa-anchor" style="color: <%= primary_color %>"></i>
              <i class="fa fa-file" style="color: <%= destination_fee_color %>"></i>
              <i class="fa fa-truck flip" style="color: <%= oncarriage_color %>"></i>
            </div>
            <p>
              <strong>Weight:</strong>
              <%= '%.2f' % cargo_data[:kg][s.id] %>&nbsp;kg
            </p>
            <% if s.load_type != 'container'%>
              <p>
                <strong>Volume:</strong>
                <%= '%.3f' % cargo_data[:vol][s.id] %>&nbsp;m<sup>3</sup>
              </p>
            <% end %>
            <% if shipment.vessel_name %>
              <p>
                <strong>Vessel:</strong>
                <%= shipment.vessel_name %>
              </p>
            <% end %>
          </div>
        </div>
        <% if s.has_pre_carriage || s.has_on_carriage %>
          <div class="delivery-info">
            <div class="cargo-info">
              <% if s.has_pre_carriage %> <p> <b> Pickup from</b>: <%=  s.pickup_address.full_address %> </p> <% end %>
              <% if s.has_on_carriage %> <p> <b> Delivery to</b>: <%=  s.delivery_address.full_address  %></p>  <% end %>
            </div>
          </div>
        <% end %>
      </div>
      <div class="no-padding">
        <div class="sub-prices">
          <div class="total-price-single">
            <h4>Cargo Details</h4>
          </div>
          <% s.cargo_items.each_with_index do |cargo, i| %>
            <div class="no_page_break item-group">
              <div class="title_row">
                <p class=""><strong><%= cargo.quantity %>&nbsp;x</strong> <%= cargo.cargo_item_type.description %></p>
              </div>
              <table class="data-table">
                <tr>
                  <td class="table-title">
                    <p >
                      <%= 
                        [cargo.dimension_x, cargo.dimension_y, cargo.dimension_z]
                          .map{|v| "#{format('%.2f',v)} cm"}.join(' x ')
                      %>
                    </p>
                  </td>
                  <td class="table-value"><span><%= '%.3f' % cargo.volume %>&nbsp;m<sup>3</span></sup></td>
                </tr>
                <% unless scope['cargo_overview_only'] %>
                  <tr>
                    <td class="table-title"><p>Gross&nbsp;Weight&nbsp;per&nbsp;Item</p></td>
                    <td class="table-value"><span><%= '%.2f' % (cargo.payload_in_kg) %>&nbsp;kg</span> </td>
                  </tr>
                <% end %>
                <tr>
                  <td class="table-title"><p>Quantity</p></td>
                  <td class="table-value"><span><%= cargo.quantity %></span></td>
                </tr>
                <tr>
                  <td class="table-title"><p>Total Volume</p></td>
                  <td class="table-value"><span><%= '%.3f' % (cargo.volume * cargo.quantity) %>&nbsp;m<sup>3</span></sup></td>
                </tr>
                <tr>
                  <td class="table-title"><p>Total&nbsp;Gross&nbsp;Weight</p></td>
                  <td class="table-value">
                    <span><%= '%.2f' % (cargo.payload_in_kg * cargo.quantity) %>&nbsp;kg</span>
                  </td>
                </tr>
                <tr>
                  <td class="table-title"><p><%= cargo_data[:chargeable_weight][s.id][cargo.id.to_s][:total_title] %></p></td>
                  <td class="table-value"><span><%= cargo_data[:chargeable_weight][s.id][cargo.id.to_s][:total_value] %></span></td>
                </tr>
              </table>
            </div>
             
          <% end %>
          <% s.containers.each_with_index do |container, i| %>
            <div class="no_page_break item-group">
              <div class="title_row">
                <p class=""><strong><%= container.quantity %>&nbsp;x</strong> <%= container.size_class.humanize.upcase %></p>
              </div>
              <table class="data-table">
                <tr>
                  <td class="table-title"><p>Quantity</p></td>
                  <td class="table-value"><span><%= container.quantity %></span></td>
                </tr>
               
                <tr>
                  <td class="table-title"><p>Cargo Type</p></td>
                  <td class="table-value"><span><%= container.size_class.humanize.upcase %></span></sup></td>
                </tr>
                <% unless scope['cargo_overview_only'] %>
                  <tr>
                    <td class="table-title"><p>Gross&nbsp;Weight&nbsp;per&nbsp;Container</p></td>
                    <td class="table-value"><span><%= '%.2f' % (container.gross_weight) %>&nbsp;kg</span> </td>
                  </tr>
                <% end %>
                <tr>
                  <td class="table-title"><p>Total&nbsp;Gross&nbsp;Weight</p></td>
                  <td class="table-value">
                    <span><%= '%.2f' % (container.gross_weight * container.quantity) %>&nbsp;kg</span>
                  </td>
                </tr>
              </table>
            </div>

          <% end %>
          <% if  s.aggregated_cargo %>
            <div class="no_page_break item-group">
              <div class="title_row">
                <p class="">"><strong>Aggregated Cargo</strong></p>
              </div>
              <table class="data-table">
                <tr>
                  <td class="table-title"><p>Total&nbsp;Gross&nbsp;Weight</p></td>
                  <td class="table-value">
                    <span><%= '%.2f' % (s.aggregated_cargo.weight) %>&nbsp;kg</span>
                  </td>
                </tr>
                 <tr>
                  <td class="table-title"><p>Total Volume</p></td>
                  <td class="table-value"><span><%= '%.3f' % (s.aggregated_cargo.volume) %>&nbsp;m<sup>3</span></sup></td>
                </tr>
                 <tr>
                  <td class="table-title"><p>Chargeable Weight</p></td>
                  <td class="table-value"><span><%= '%.2f' % s.aggregated_cargo.chargeable_weight %></span></td>
                </tr>
              </table>
            </div>

          <% end %>
        </div>
      </div>
      <% ['trucking_pre', 'export', 'cargo', 'import', 'trucking_on' ].each do |charge_key| %>
        <% if scope['freight_in_original_currency']  && charge_key == 'cargo'
            original_charge = s.selected_offer[charge_key]
            charge = {
              "total" => {
                "value" => 0.0,
                "currency" => ""
              }
            }
            original_charge.keys
              .reject {|k| ['name', 'total', 'edited_total'].include?(k)}
              .each do |k|
                charge[k] = original_charge[k]
                charge[k]['total']['value'] = 0.0
                item_charge_keys = original_charge[k].keys
                  .reject {|fk| ['name', 'total', 'edited_total'].include?(fk)}
                if item_charge_keys.length == 1 && item_charge_keys.first.include?('unknown')
                  hide_cargo_sub_totals = true
                end
                item_charge_keys.each do |fk|
                  charge['total']['value'] += original_charge[k][fk]['value']
                  charge['total']['currency'] = original_charge[k][fk]['currency']
                  charge[k]['total']['value'] += original_charge[k][fk]['value']
                  charge[k]['total']['currency'] = original_charge[k][fk]['currency']
                end
              end
              charge['name'] = original_charge['name']
          else
            charge = s.selected_offer[charge_key]
          end %>
        <% next if !charge%>
        <% charge_name =  if charge_key == 'cargo' && charge['name'] == 'Freight' 
                            "#{s.mode_of_transport} Freight"
                          else 
                            charge["name"]
                          end
        %>
        <div class="sub-prices no_page_break">
          <div class="total-price-single">
            <h4>
                <%= charge_name %>
                <% if scope['show_chargeable_weight'] && !['import', 'export'].include?(charge_key) %>
                  <%= cargo_data[:chargeable_weight][s.id][charge_key.to_sym] %>
                 <% end %>
            </h4>
             <% if charge_key == 'cargo'
                no_custom_fees = charge
                                 .except('name', 'edited_total', 'total')
                                 .values
                                 .flat_map(&:keys).none? {|k| k.include?('unknown')}
              end %>
            <% if charge_key != 'cargo' &&
                  no_custom_fees && 
                  charge != "Grand Total" &&
                  !scope['hide_grand_total'] || (charge_key == 'cargo' && !hide_cargo_sub_totals && no_custom_fees)
            %>
              <h3><%= '%.2f' % charge["total"]["value"].to_f %>&nbsp;<%= charge["total"]["currency"] %></h3>
            <% end %>
          </div>
          <div class="subtotal-price-group">
            <% if charge != "Grand Total" %>
              <%
                sorted_charges_by_unit = if (charge_key == 'cargo' && !scope['fine_fee_detail'])
                   charge
                      .except("total", "edited_total", "name")
                      .keys.map{|k| obj = charge[k]; obj['key'] = k; obj}
                      .group_by{|c| c['item_id']}
                      .inject({}) do |memo, (k, g)|
                          memo[k] = g.group_by{|c| c['currency']}
                          memo
                      end
                  else
                    charge.except("total", "edited_total", "name").keys
                      .map{|k| obj = charge[k];  obj['item_id'] = k; obj.except("total", "edited_total", "name")}
                      .map{|obj| item_id = obj.delete('item_id'); obj.keys.map{|k| sub_charge = obj[k]; sub_charge['key'] = k; sub_charge['item_id'] = item_id; sub_charge}}
                      .flatten
                      .group_by{|c| c['item_id']}
                      .inject({}) do |memo, (k, g)|
                          memo[k] = g.group_by{|c| c['currency']}
                          memo
                      end
                  end
                %>
              <% sorted_charges_by_unit.each do |unit_and_sorted_charges| %>
                <% 
                  unit_id = unit_and_sorted_charges.first
                  sorted_charges = unit_and_sorted_charges.second
                  if unit_id.present? && unit_id.is_number?
                    unit = s.cargo_units.find_by(id: unit_id.to_i)
                    desc = s.lcl? ? unit&.cargo_item_type&.description : unit.size_class.humanize.upcase
                  elsif unit_id == 'shipment'
                    desc = 'Shipment Fees'
                  end
                %>
                <% if desc && ['import', 'export'].include?(charge_key) %>
                  <div class="cargo_title">
                    <%= unit ? "#{desc} x #{unit.quantity}" : "#{desc}" %>
                  </div>
                <% end %>
                <% sorted_charges.each do |currency_key, sub_charges| %>
                  <% if (charge_key != 'cargo' || (charge_key == 'cargo' && !hide_cargo_sub_totals)) &&
                      sub_charges.none?{|c| c['key'].include?('unknown')}%>
                    <div class="subtotal-currency-single">
                      <h4>Fees charged in <%= currency_key %>:</h4>
                      <h3>
                        <%=
                          if scope['hide_sub_totals'] && charge_key.include?('unknown')
                            "#{s.mode_of_transport} Freight: "
                          elsif charge_key == 'cargo' && !scope['fine_fee_detail']
                            "#{'%.2f' % sub_charges.sum{|c| c['total']['value']}}&nbsp;#{currency_key}"
                          else
                            "#{'%.2f' % sub_charges.sum{|c| c['value']}}&nbsp;#{currency_key}"
                          end
                          %>
                      </h3>
                    </div>
                  <% end %>
                  <table class="data-table">
                    <% sub_charges.each_with_index do |sub_charge, i| %>
                      <tr>
                        <%
                            sub_charge_name = if 'cargo' == charge_key && scope['consolidated_cargo']
                              "Consolidated Freight Rate"
                            elsif 'cargo' == charge_key && scope['fine_fee_detail'] && sub_charge['key'].include?('unknown')
                              "#{s.mode_of_transport.capitalize} Freight: #{sub_charge['name']}"
                            elsif 'cargo' == charge_key && !scope['fine_fee_detail']
                              "#{s.mode_of_transport.capitalize} Freight Rate #{i + 1}"
                            elsif ['trucking_on', 'trucking_pre'].include?(charge_key)
                              'Trucking Rate'
                            else
                              case scope['fee_detail']
                                when 'key'
                                  sub_charge['key'].upcase
                                when 'key_and_name'
                                  "#{sub_charge['key'].upcase} - #{sub_charge['name']}"
                                when 'name'
                                  sub_charge['name']
                                end
                            end
                        %>
                        <td class="table-title"><p><%= sub_charge_name %></p></td>
                        <td class="table-quantity">
                          <% if 'cargo' == charge_key && scope['fine_fee_detail'] %>
                          
                            <p><%= cargo_data[:item_strings][s.id][sub_charge['item_id']] %></p>
                          <% end %>
                        </td>
                        <% if sub_charge["key"].include?('unknown') %>
                          <td class="table-value"></td>
                        <% elsif sub_charge["value"] && !scope['hide_sub_totals'] %>
                          <td class="table-value"><span> <%= '%.2f' % sub_charge["value"].to_f %>&nbsp;<%= sub_charge["currency"] %></span></td>
                        <% elsif scope['hide_sub_totals'] && scope['cargo_price_notes'] && scope['cargo_price_notes'][charge_key] %>
                          <td class="table-value"><span> <%= scope['cargo_price_notes'][charge_key.to_s] %></span></td>
                        <% elsif !scope['hide_sub_totals'] && (!scope['cargo_price_notes'] || scope['cargo_price_notes'] && !scope['cargo_price_notes'][charge_key]) %>
                          <td class="table-value"><span> <%= '%.2f' % sub_charge["total"]["value"] %>&nbsp;<%= sub_charge["total"]["currency"] %></span></td>
                        <% end %>
                      </tr>
                    <% end %>
                  </table>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
      <% unless hide_grand_total[s.id] %>
        <div class="total-row">
          <h4>Total</h4>
          <p class="quote"><%= '%.2f' % s.selected_offer["total"]["value"].to_f %>
            &nbsp;<%= s.selected_offer["total"]["currency"] %>
          </p>
        </div>
      <% end %>
      <% if scope["quote_notes"] %>
        <div class="tenant-notes-row">
          <p class="">
            <%= tenant.scope["quote_notes"] || "" %>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>
  <% unless remarks.empty? %>
    <div class="remarks">
      <h4>Remarks:</h4>
      <ul>
        <% remarks.each do  |remark|%>
          <li>
            <p class="hyphens">
              <%= simple_format(remark.body) %>
            </p>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <% unless notes.empty? %>
    <div class="remarks">
      <h4>Notes: </h4>
      <ul> <% notes.each do |note| %>
        <li class="note-header"> <%= note.header %></li>
        <li>
          <p class="hyphens">
            <%= simple_format(note.body)  %>
          </p>
        </li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <% unless content['disclaimer'].nil? %>
    <div class="remarks">
      <ul> <% content['disclaimer'].each do |section| %>
        <li class="note-header"> <%= section['text'] %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>
