apiVersion: v1
kind: Pod
metadata:
  name: migrate-<%= deployment_id %>
  labels:
    app.kubernetes.io/component: migrate
    app.kubernetes.io/instance: polaris
    app.kubernetes.io/managed-by: Shipit
    app.kubernetes.io/name: polaris-<%= deployment_id %>
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  activeDeadlineSeconds: 300
  restartPolicy: Never

  containers:
  - name: migrate
    image: 003688427525.dkr.ecr.eu-central-1.amazonaws.com/polaris:<%= current_sha %>
    imagePullPolicy: IfNotPresent
    args:
    - bundle
    - exec
    - rails
    - db:migrate:with_data
    env:
    - name: RAILS_ENV
      value: production      
    envFrom:
    - secretRef:
        name: polaris-env
        optional: false
    resources:
      requests:
        cpu: 500m
        memory: 1G
    securityContext:
      readOnlyRootFilesystem: false
      runAsNonRoot: true
      runAsUser: 1000
  serviceAccountName: polaris
  securityContext:
    fsGroup: 1000
